name: CI + Deploy (EC2)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-ec2
  cancel-in-progress: false

jobs:
  test:
    name: CI (lint/tests)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}

          # Add these:
          debug: true
          timeout: 60s
          command_timeout: 30m

          script_stop: true
          script: |
            set -euo pipefail
            set -x            
            APP_DIR="$HOME/foragers-assistant"
            APP_FILE="backend.py"
            PY="$APP_DIR/.venv/bin/python"
            cd "$APP_DIR"
            # Pull latest code (rebase is risky in automation; use a clean sync)
            git fetch --all
            git reset --hard origin/main

            # Ensure venv exists
            if [ ! -d ".venv" ]; then
              python3.12 -m venv .venv
            fi

            # Stop previous process (if any) by matching the exact command
            # This avoids killing unrelated python processes.
            pkill -f "$PY $APP_FILE" || true

            # Start new process
            nohup "$PY" "$APP_FILE" > log.txt 2>&1 &

            echo "Started. Tail logs with: tail -n 200 -f $APP_DIR/log.txt"